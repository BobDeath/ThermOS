<!DOCTYPE html>
<head>
    <meta text/html;charset="utf-8">
    <link rel="shortcut icon" href="/static/images/favicon.png">
    <title>Thermostat</title>
    
    <!-- Bootstrap core CSS -->
    <link href="/static/css/jquery.mobile-1.4.5.css" rel="stylesheet">
    <link href="/static/css/bootstrap.css" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">

    <script type='application/javascript' src="{{url_for('static',filename='fastclick.js')}}"></script>
    <script src="{{url_for('static',filename='jquery.min.js')}}"></script>
    <script>
        $(document).on("mobileinit", function () {
            $.mobile.hashListeningEnabled = false;
            $.mobile.pushStateEnabled = false;
            $.mobile.changePage.defaults.changeHash = false;
        });
    </script>
    <script src="{{url_for('static',filename='jquery.mobile-1.4.5.min.js')}}"></script>
    <script src="{{url_for('static',filename='svg.jquery.js')}}"></script>
    <script src="{{url_for('static',filename='pygal-tooltips.js')}}"></script>
    <script src="{{url_for('static',filename='skycons.js')}}"></script>
    
    <script>window.jQuery || document.write('<script src="{{
      url_for('static', filename='jquery.js') }}">\x3C/script>')
    </script>

    <script type="application/javascript">
    // popup examples
    $( document ).on( "pagecreate", function() {
        // The window width and height are decreased by 30 to take the tolerance of 15 pixels at each side into account
        function scale( width, height, padding, border ) {
            var scrWidth = $( window ).width() - 30,
                scrHeight = $( window ).height() - 30,
                ifrPadding = 2 * padding,
                ifrBorder = 2 * border,
                ifrWidth = width + ifrPadding + ifrBorder,
                ifrHeight = height + ifrPadding + ifrBorder,
                h, w;
            if ( ifrWidth < scrWidth && ifrHeight < scrHeight ) {
                w = ifrWidth;
                h = ifrHeight;
            } else if ( ( ifrWidth / scrWidth ) > ( ifrHeight / scrHeight ) ) {
                w = scrWidth;
                h = ( scrWidth / ifrWidth ) * ifrHeight;
            } else {
                h = scrHeight;
                w = ( scrHeight / ifrHeight ) * ifrWidth;
            }
            return {
                'width': w - ( ifrPadding + ifrBorder ),
                'height': h - ( ifrPadding + ifrBorder )
            };
        };

        $( "#popupPanel" ).on({
            popupbeforeposition: function() {
                var size = scale( 800, 600, 0, 1 ),
                    w = size.width,
                    h = size.height;
                $( "#popupPanel iframe" )
                    .attr( "width", w )
                    .attr( "height", h );
            },
            popupafterclose: function() {
                $( "#popupPanel iframe" )
                    .attr( "width", 0 )
                    .attr( "height", 0 )
                    .attr( "src", "about:blank");
            }
        });
        
    });
    </script>
    <!-- This will update the current indoor temp as fed from getIndoorTemp.py
         Refreshes every 5 seconds -->


    <script>
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
        $(function() {
           
            $('a[data-src="/fan"]').bind('click', function() {
                $.ajax({
                    type : "POST",
                    data : { toggle: true},
                    url : $SCRIPT_ROOT + "/_fanMode",
                    success : function(result){
                        $('#fanStatus').html(result);
                    }
                })
            });
        });
  
    function liveUpdate() {

        $.ajax({
            url : $SCRIPT_ROOT + "/_liveUpdate",
            success : function(result){
                $('#targetTemps').html($(result).find('#targetTemps').html());
                $('#daemonStatusSpan').html($(result).find('#daemonContainer').html());
                $('#whatsOnSpan').html($(result).find('#whatContainer').html());
                $('#indoorTempSpan').html($(result).find('#indoorTempContainer').html());
                $('#outdoorTempContainer').html($(result).find('#currentWeather').html());
                $('title').html('Currently ' + $(result).find('#indoorTempContainer').html() + '&deg;');
                /*$('#schedule').html($(result).find('#updateTemp').html());*/
            }
        })
    };

    window.setInterval(function(){
      liveUpdate()
    }, 100000);
    </script>
</head>

<body onload="liveUpdate()">
    
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav pager">
            <li class="modern embossed-link"><a data-src="/fan"><img src="static/images/fan-small.png"><label id="fanStatus">{{ fanstatus }}</label></a></li>
            <li class="modern embossed-link"><a class="button-popup" href="#popupPanel" data-rel="popup" data-position-to="window" data-src="/_daemonLogs"><img src="static/images/system-small.png"></a></li>
            <li class="modern embossed-link"><a class="button-popup" href="#popupPanel" data-rel="popup" data-position-to="window" data-src="/admin/schedule"><img src="static/images/schedule-small.png"></a></li>
            <li class="modern embossed-link"><a class="button-popup" href="#popupPanel" data-rel="popup" data-position-to="window" data-src="/hold"><img src="static/images/hold-small.png"></a></li>
            <li class="modern embossed-link"><a class="button-popup" href="#popupPanel" data-rel="popup" data-position-to="window" data-src="/settings"><img src="static/images/settings-small.png"></a></li>
            <li class="modern embossed-link"><a class="button-popup" href="#popupPanel" data-rel="popup" data-position-to="window" data-src="/_daemonLogs"><img src="static/images/logs-small.png"></a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div data-role="popup" id="popupPanel" data-overlay-theme="a" data-theme="a" data-corners="false" data-tolerance="15,15">
        <a href="#" data-rel="back" class="ui-btn ui-btn-b ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right close">Close</a>
        <iframe data-src="/admin/schedule" src="about:blank" width="auto" height="auto" seamless=""></iframe>
    </div>
    
    <div id="content">
        <div id="container1">
            <div>
                <p id="indoorLabel">INDOOR</p>
                    <p id="currentTemp"><span class="unit-{{ unit }}" id="indoorTempSpan"></span></p>
                    <div id="currentSchedule">
                        <div id="targetTemps">
                          <div id="targetHeat"></div>
                          <div id="targetCool"></div>
                        </div>
                    </div>
            </div>
            
        </div>
        <div class={{ weatherVisible }} id="container2">
            <div>
                <p id="outdoorLabel">OUTDOOR</p>
                <div id="outdoorTempContainer"></div>
                <span id="currentScheduleSpan"></span>
                <span id="daemonStatusSpan"></span>
                <span id="whatsOnSpan"></span>
            </div>
        </div>
            <div class="push"></div>
    </div>
    
    <div id="footer">
        <marquee id="footerAlerts">{{ alerts|safe }}</marquee>
    </div>
</body>
<script>
$(".button-popup").click(function(){
    var iframe = $( "#popupPanel iframe" );
    iframe.attr("src", $(this).data("src")); 
});
</script>